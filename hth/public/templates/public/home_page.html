<!doctype html>
<html ng-app="HtH">

    <head>
        <style>
            .whole-screen-container {
                height: 100vh;
            }

            .tile {
                background-size: cover;
                height: 100vh;
            }

            .tile p {
                position: relative;
                top: 30%;
                transform: translateY(-50%);
                text-align: center;
                color: white;
                background-color: #fff;
                background-color: rgba(255,255,255,0.5);
            }

        </style>
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

        <!-- Latest compiled and minified JavaScript -->
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="//lipis.github.io/flag-icon-css/css/flag-icon.css">
        <title>Here to Help</title>
    </head>

    <body ng-controller="TileController">
    
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <ul class="nav navbar-nav navbar-right">
                    <li class="dropdown" dropdown on-toggle="toggled(open)">
                      <a href class="dropdown-toggle" dropdown-toggle>
                           <span class="flag-icon flag-icon-gb"></span>/
                           <span class="flag-icon flag-icon-ie"></span>
                           <span class="caret"></span>
                      </a>
                      <ul class="dropdown-menu list-inline">
                           <li ng-repeat="choice in languages">
                               <a ng-click="selectedLanguage = choice"><span class="flag-icon flag-icon-{$ choice $}"</span></a>
                           </li>
                      </ul>
                    </li>
                </ul>
            </div>
        </nav>


        <div id="categories" class="container-fluid whole-screen-container" ng-hide="entries">
            <div class="row">
                <div class="col-md-4 tile" style="background-image: url(http://wintershelter.org.uk/wp-content/uploads/2012/08/homeless-shelter.jpg)" ng-click="showEntries('shelter');">
                    <p>
                        <i class="fa fa-bed fa-6"></i>
                        <span class="abstract">Where to find a bed</span>
                    <p>
                </div>
                <div class="col-md-4 tile" style="background-image: url(http://www.pjohare.com/wp-content/uploads/2014/04/Ulster-Fry1.jpg)">
                    <p>
                        <i class="fa fa-cutlery fa-6"></i>
                        <span class="abstract">Where to find food</span>
                    <p>
                </div>
                <div class="col-md-4 tile" style="background-image: url(http://www.samaritans.org/sites/default/files/branch/samaritans-9361.jpg)">
                    <p>
                        <i class="fa fa-plus fa-6"></i>
                        <span class="abstract">Where to find help</span>
                    <p>
                </div>
            </div>
        </div>

        <div id="entries" class="container-fluid" ng-show="entries" ng-hide="entry">
            <div class="row">
                <div class="col-md-4" ng-repeat="entry in entries" ng-click="showEntry(entry)">
                    {$ entry.fields.title $}
                </div>
            </div>
        </div>

        <div id="entry" class="container-fluid" ng-show="entry">
            <div class="row">
                <div class="col-md-4"></div>
                <div class="col-md-4">Name: {$ entry.fields.title $}</div>
                <h1 id="status" ng-bind="phone_status"></h1>
                <button ng-click="toggleCall();">Call</button>
            </div>
        </div>

        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
        <script src="http://angular-ui.github.io/bootstrap/ui-bootstrap-tpls-0.12.1.min.js"></script>
        <script type="text/javascript" src="//static.twilio.com/libs/twiliojs/1.1/twilio.min.js"></script>
        <script>

            Twilio.Device.setup("{{ twilio_token }}");
            var connection=null;


            var hthApp = angular.module('HtH', ['ui.bootstrap']).config(['$httpProvider', '$interpolateProvider', function($httpProvider, $interpolateProvider) {
                                                                    $interpolateProvider.startSymbol('{$');
                                                                    $interpolateProvider.endSymbol('$}');
                                                                    $httpProvider.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded';
                                                                    }]);//.run(['$http', '$cookies', function($http, $cookies) {
                                                                        //    $http.defaults.headers.post['X-CSRFToken'] = $cookies.csrftoken;
                                                                       // }]);

            hthApp.controller('TileController', function($scope, TileService) {
                $scope.entries = null;
                $scope.entry = null;
                $scope.phone_status = "Offline"

                $scope.showEntries = function(entry_category) {
                    TileService.getEntries(entry_category).then(
                                function( friends ) {
                                    $scope.entries = friends ;
                                }
                        );
                }

                $scope.showEntry = function(entry) {
                    $scope.entry = entry;
                }

                $scope.toggleCall = function() {
                    params = { "tocall" : ""};
                    connection = Twilio.Device.connect(params);
                    connection.sendDigits("");
                };

                $scope.languages = [
                        'gb',
                        'pl',
                        'ro',
                        'bg'
                         ];

                $scope.selectedLanguage = 'gb';

                $scope.languageStatus = {
                        isopen: false
                };

                $scope.toggleLanguageDropdown = function($event) {
                            $event.preventDefault();
                            $event.stopPropagation();
                            $scope.languageStatus.isopen = !$scope.languageStatus.isopen;
                };

                Twilio.Device.ready(function (device) { $scope.phone_status = "Ready to start call"; });
                Twilio.Device.offline(function (device) { $scope.phone_status = "Offline"; });
                Twilio.Device.error(function (error) { console.log(error); $scope.phone_status = "There has been an error"; });
                Twilio.Device.connect(function (conn) { $scope.phone_status = "Successfully established call"; });
                Twilio.Device.disconnect(function (conn) { $scope.phone_status = "Call ended"; });
            });

            hthApp.service('TileService', function( $http, $q ) {
                // Return public API.
                return({
                    getEntries: getEntries
                });

                function getEntries(entry_type) {
                    var request = $http({
                       method: "get",
                        url: "/api",
                        params: {
                            entry_type: entry_type
                        },
                    });
 
                    return( request.then( handleSuccess, alert ) );
 
                }

                function handleSuccess( response ) {
 
                   return( response.data );
 
                }
    

            });

        </script>

    </body>

</html>
